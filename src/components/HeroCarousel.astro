---
import { ChevronLeft, ChevronRight } from "lucide-astro";
import { promos } from "../data/promos";
---

<div
    id="hero-carousel"
    class="md:w-1/2 relative group w-full max-w-lg mx-auto md:max-w-none md:px-4"
>
    <div
        class="w-full h-[300px] sm:h-[400px] md:h-[500px] bg-slate-100 rounded-[2.5rem] md:rounded-[3rem] overflow-hidden shadow-2xl relative"
    >
        {
            promos.map((promo, i) => (
                <div
                    class="carousel-slide absolute inset-0 transition-opacity duration-1000 ease-in-out"
                    style={`opacity: ${i === 0 ? "1" : "0"}; z-index: ${i === 0 ? "10" : "0"}`}
                    data-index={i}
                >
                    <img
                        src={promo.image}
                        alt={promo.title}
                        class="w-full h-full object-cover"
                        style={i === 0 ? "will-change: transform;" : ""}
                        loading={i === 0 ? "eager" : "lazy"}
                        fetchpriority={i === 0 ? "high" : "low"}
                        decoding={i === 0 ? "sync" : "async"}
                    />
                    <div class="absolute inset-x-0 bottom-0 bg-gradient-to-t from-black/80 to-transparent p-6 md:p-10 pt-16 md:pt-20">
                        <p class="text-white font-black text-lg md:text-2xl tracking-tight">
                            {promo.title}
                        </p>
                        <p class="text-white/80 text-[10px] md:text-sm font-medium line-clamp-1">
                            {promo.description}
                        </p>
                    </div>
                </div>
            ))
        }
        <button
            id="carousel-prev"
            class="absolute left-4 top-1/2 -translate-y-1/2 z-20 p-2 md:p-3 bg-white/20 backdrop-blur-md text-white rounded-full hover:bg-white/40 transition-all md:opacity-0 group-hover:opacity-100 active:scale-90"
        >
            <ChevronLeft class="w-6 h-6" />
        </button>
        <button
            id="carousel-next"
            class="absolute right-4 top-1/2 -translate-y-1/2 z-20 p-2 md:p-3 bg-white/20 backdrop-blur-md text-white rounded-full hover:bg-white/40 transition-all md:opacity-0 group-hover:opacity-100 active:scale-90"
        >
            <ChevronRight class="w-6 h-6" />
        </button>
        <div
            id="carousel-dots"
            class="absolute bottom-4 md:bottom-6 left-1/2 -translate-x-1/2 z-20 flex gap-1.5 md:gap-2"
        >
            {
                promos.map((_, i) => (
                    <button
                        class:list={[
                            "carousel-dot h-1 md:h-1.5 rounded-full transition-all",
                            i === 0
                                ? "w-6 md:w-8 bg-white"
                                : "w-1.5 md:w-2 bg-white/40",
                        ]}
                        data-index={i}
                    />
                ))
            }
        </div>
    </div>
</div>

<script define:vars={{ totalSlides: promos.length }}>
    let carouselInterval = null;

    function initCarousel() {
        let currentSlide = 0;

        function updateCarousel() {
            const slides = document.querySelectorAll(".carousel-slide");
            const dots = document.querySelectorAll(".carousel-dot");

            slides.forEach((slide, i) => {
                if (slide instanceof HTMLElement) {
                    slide.style.opacity = i === currentSlide ? "1" : "0";
                    slide.style.zIndex = i === currentSlide ? "10" : "0";
                }
            });

            dots.forEach((dot, i) => {
                dot.className =
                    i === currentSlide
                        ? "carousel-dot h-1 md:h-1.5 w-6 md:w-8 bg-white rounded-full transition-all"
                        : "carousel-dot h-1 md:h-1.5 w-1.5 md:w-2 bg-white/40 rounded-full transition-all";
            });
        }

        function nextSlide() {
            currentSlide = (currentSlide + 1) % totalSlides;
            updateCarousel();
        }

        function prevSlide() {
            currentSlide =
                currentSlide === 0 ? totalSlides - 1 : currentSlide - 1;
            updateCarousel();
        }

        // Clear previous interval if exists
        if (carouselInterval) {
            clearInterval(carouselInterval);
        }

        // Defer auto-advance to after first paint
        const startAutoAdvance = () => {
            carouselInterval = setInterval(nextSlide, 5000);
        };

        if ("requestIdleCallback" in window) {
            requestIdleCallback(startAutoAdvance);
        } else {
            setTimeout(startAutoAdvance, 100);
        }

        // Button controls - clone to remove old listeners
        const nextBtn = document.getElementById("carousel-next");
        const prevBtn = document.getElementById("carousel-prev");

        if (nextBtn) {
            const newNextBtn = nextBtn.cloneNode(true);
            nextBtn.parentNode?.replaceChild(newNextBtn, nextBtn);
            newNextBtn.addEventListener("click", nextSlide);
        }

        if (prevBtn) {
            const newPrevBtn = prevBtn.cloneNode(true);
            prevBtn.parentNode?.replaceChild(newPrevBtn, prevBtn);
            newPrevBtn.addEventListener("click", prevSlide);
        }

        // Dot controls - clone to remove old listeners
        document.querySelectorAll(".carousel-dot").forEach((dot) => {
            const newDot = dot.cloneNode(true);
            dot.parentNode?.replaceChild(newDot, dot);
            newDot.addEventListener("click", (e) => {
                const target = e.currentTarget;
                if (target instanceof HTMLElement) {
                    currentSlide = parseInt(target.dataset.index || "0");
                    updateCarousel();
                }
            });
        });
    }

    // Run on page load
    initCarousel();
</script>
